<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.19" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.66" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://mister-hope.github.io/posts/rd/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/java-concurrent-1.html"><meta property="og:site_name" content="孤独星球漫游"><meta property="og:title" content="Java多线程总结（一）：系统理论基础"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-12-22T07:41:10.000Z"><meta property="article:tag" content="Java"><meta property="article:published_time" content="2024-12-21T00:00:00.000Z"><meta property="article:modified_time" content="2024-12-22T07:41:10.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Java多线程总结（一）：系统理论基础","image":[""],"datePublished":"2024-12-21T00:00:00.000Z","dateModified":"2024-12-22T07:41:10.000Z","author":[{"@type":"Person","name":"Raymond","url":"https://avatars.githubusercontent.com/theflyingraymond"}]}</script><title>Java多线程总结（一）：系统理论基础 | 孤独星球漫游</title><meta name="description" content="孤独星球漫游">
    <link rel="preload" href="/assets/style-B_Z7j5TJ.css" as="style"><link rel="stylesheet" href="/assets/style-B_Z7j5TJ.css">
    <link rel="modulepreload" href="/assets/app-pa7HclEc.js"><link rel="modulepreload" href="/assets/java-concurrent-1.html-C_vcuPIG.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-Bk_r6SvY.js" as="script"><link rel="prefetch" href="/assets/intro.html-BYmBES7e.js" as="script"><link rel="prefetch" href="/assets/index.html-rA1fr8ET.js" as="script"><link rel="prefetch" href="/assets/2024铁山坪半马.html-CrvKa0pl.js" as="script"><link rel="prefetch" href="/assets/index.html-CM7852ms.js" as="script"><link rel="prefetch" href="/assets/binary_search.html-BblYnAZd.js" as="script"><link rel="prefetch" href="/assets/index.html-Be3J2oKH.js" as="script"><link rel="prefetch" href="/assets/sliding_window_and_double_pointer.html-Dh8b1CbB.js" as="script"><link rel="prefetch" href="/assets/chapter1.html-Jt3_WA5n.js" as="script"><link rel="prefetch" href="/assets/index.html-B0ebkOg1.js" as="script"><link rel="prefetch" href="/assets/index.html-D-C_j8wy.js" as="script"><link rel="prefetch" href="/assets/字符串大小写转换中Locale的作用.html-d4zwTcAb.js" as="script"><link rel="prefetch" href="/assets/main-chapter0.html-ChTKx2kT.js" as="script"><link rel="prefetch" href="/assets/main-chapter1.html-hi-zarBD.js" as="script"><link rel="prefetch" href="/assets/main-chapter2.html-DBWsnBEa.js" as="script"><link rel="prefetch" href="/assets/main-chapter3.html-DhBJhTk9.js" as="script"><link rel="prefetch" href="/assets/main-chapter4.html-D0EKHfB_.js" as="script"><link rel="prefetch" href="/assets/main-chapter5.html-BmT4nGYM.js" as="script"><link rel="prefetch" href="/assets/mybatis使用1-配置.html-DmRtezn8.js" as="script"><link rel="prefetch" href="/assets/mybatis使用2-增删改查.html-BSH3MeGH.js" as="script"><link rel="prefetch" href="/assets/mybatis使用3-动态SQL.html-inIipoY0.js" as="script"><link rel="prefetch" href="/assets/mybatis使用4-与Spring整合.html-C-C_9NRc.js" as="script"><link rel="prefetch" href="/assets/index.html-5SoSQHD5.js" as="script"><link rel="prefetch" href="/assets/index.html-BOyEUA3t.js" as="script"><link rel="prefetch" href="/assets/os-cp1.html-BSu7vvuS.js" as="script"><link rel="prefetch" href="/assets/index.html-BLCoQsVj.js" as="script"><link rel="prefetch" href="/assets/java-concurrent-2.html-C9rBBYIw.js" as="script"><link rel="prefetch" href="/assets/java-concurrent-3.html-CpmE910_.js" as="script"><link rel="prefetch" href="/assets/404.html-BArh-UmW.js" as="script"><link rel="prefetch" href="/assets/index.html-9iw6DP_o.js" as="script"><link rel="prefetch" href="/assets/index.html-CFR-UTAJ.js" as="script"><link rel="prefetch" href="/assets/index.html-Bsu8aAwH.js" as="script"><link rel="prefetch" href="/assets/index.html-BYUz-GdZ.js" as="script"><link rel="prefetch" href="/assets/index.html-g_2jeFWv.js" as="script"><link rel="prefetch" href="/assets/index.html-Dk_4neUs.js" as="script"><link rel="prefetch" href="/assets/index.html-D9Ji0_KY.js" as="script"><link rel="prefetch" href="/assets/index.html-Bt22bC9X.js" as="script"><link rel="prefetch" href="/assets/index.html-DAqowfh1.js" as="script"><link rel="prefetch" href="/assets/index.html-CfF9ked6.js" as="script"><link rel="prefetch" href="/assets/index.html-CbjSSN9G.js" as="script"><link rel="prefetch" href="/assets/index.html-DItkGPcY.js" as="script"><link rel="prefetch" href="/assets/index.html-BQXQxd_r.js" as="script"><link rel="prefetch" href="/assets/index.html-Bo4CCtZu.js" as="script"><link rel="prefetch" href="/assets/index.html-C5mnGwbs.js" as="script"><link rel="prefetch" href="/assets/index.html-Camlyij6.js" as="script"><link rel="prefetch" href="/assets/index.html-D5MFrMQ1.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-GXRgw7eJ.js" as="script"><link rel="prefetch" href="/assets/setupDevtools-7MC2TMWH-CJBHHN-I.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/" aria-label="带我回家"><img class="vp-nav-logo" src="https://theme-hope-assets.vuejs.press/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">孤独星球漫游</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="博客主页"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span><!--]-->博客主页<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/posts/rd/" aria-label="月明好渡江湖"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><!--]-->月明好渡江湖<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/posts/sports/" aria-label="三百六十五里路"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><!--]-->三百六十五里路<!----></a></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/" aria-label="博客主页"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span><!--]-->博客主页<!----></a></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">文章</span><!----></p><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><span class="vp-sidebar-title">三百六十五里路</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><span class="vp-sidebar-title">月明好渡江湖</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><span class="vp-sidebar-title">Java</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">多线程</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/posts/rd/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/java-concurrent-1.html" aria-label="Java多线程总结（一）：系统理论基础"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span><!--]-->Java多线程总结（一）：系统理论基础<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/posts/rd/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/java-concurrent-3.html" aria-label="Java多线程总结（三）：volatile与Synchronized"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span><!--]-->Java多线程总结（三）：volatile与Synchronized<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/posts/rd/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/java-concurrent-2.html" aria-label="Java多线程总结（二）：Java理论基础"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span><!--]-->Java多线程总结（二）：Java理论基础<!----></a></li></ul></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/posts/rd/java/%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%A7%E5%B0%8F%E5%86%99%E8%BD%AC%E6%8D%A2%E4%B8%ADLocale%E7%9A%84%E4%BD%9C%E7%94%A8.html" aria-label="字符串大小写转换中Locale的作用"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span><!--]-->字符串大小写转换中Locale的作用<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><span class="vp-sidebar-title">MyBatis</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><span class="vp-sidebar-title">MySQL</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><span class="vp-sidebar-title">操作系统</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><span class="vp-sidebar-title">数据结构与算法</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><span class="vp-sidebar-title">设计模式</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Java多线程总结（一）：系统理论基础</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://avatars.githubusercontent.com/theflyingraymond" target="_blank" rel="noopener noreferrer">Raymond</a></span><span property="author" content="Raymond"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2024年12月21日</span><meta property="datePublished" content="2024-12-21T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 12 分钟</span><meta property="timeRequired" content="PT12M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color2 clickable" role="navigation">计算机</span><!--]--><meta property="articleSection" content="计算机"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color8 clickable" role="navigation">Java</span><!--]--><meta property="keywords" content="Java"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc" vp-toc><!----><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#一、java多线程发展历史">一、Java多线程发展历史</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#二、缓存一致性">二、缓存一致性</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-1-两种cpu架构">2.1 两种CPU架构</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-2-mesi协议">2.2 MESI协议</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-3-内存屏障">2.3 内存屏障</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content" vp-content><h1 id="java多线程总结-一-系统理论基础" tabindex="-1"><a class="header-anchor" href="#java多线程总结-一-系统理论基础"><span>Java多线程总结（一）：系统理论基础</span></a></h1><!-- more --><h2 id="一、java多线程发展历史" tabindex="-1"><a class="header-anchor" href="#一、java多线程发展历史"><span>一、Java多线程发展历史</span></a></h2><p>Java多线程的发展可以简单从几个较为关键的点来介绍：<br> ● Java1.5之前：<br> ○ 提供基础的多线程支持，包括Thread和Runnable接口<br> ○ 提供最初的synchronized配合wait()、notify()、notifyAll()的线程同步机制<br> ● Java1.5：<br> ○ 引入了J.U.C，并配套有了大量的并发工具，<br> ○ 引入了Future和Callable，处理异步返回值的问题<br> ○ 完善volatile语义<br> ● Java1.6：synchronized体系知耻而后勇，迎来传说中的“锁升级”<br> ● Java1.7：引入Fork/Join框架<br> ● Java1.8：CompletableFuture携流式API登场，提供的更为丰富的异步编程处理模型<br> ● Java1.9及之后：值得一提的就是Java19的虚拟线程</p><h2 id="二、缓存一致性" tabindex="-1"><a class="header-anchor" href="#二、缓存一致性"><span>二、缓存一致性</span></a></h2><h3 id="_2-1-两种cpu架构" tabindex="-1"><a class="header-anchor" href="#_2-1-两种cpu架构"><span>2.1 两种CPU架构</span></a></h3><p>SMP<br><img src="/assets/concurrent-smp-CBKlATyz.png" alt="SMP" loading="lazy"><br> SMP(symmetrical multi-processing, 对称多处理器技术)，在一个计算机上集成多个CPU，各个CPU之间共享内存子系统及总线系统。在任务调度时，系统将任务对称地分布在多个CPU上，所有处理器平等访问内存、IO和外部中断，提高了系统的批处理能力，但同时因为内存共享也带来了高速缓存一致性的问题。缓存一致性的问题通常需要硬件支持，会有硬件性能损耗，并且随着CPU数量的增加而增加，比如一个96核的服务器，每个CPU运行一个线程，每个线程访问同一个变量V，当其中一个线程对V做出修改时，会把消息广播到其余的CPU上，这会造成极大的硬件性能损耗，所以SMP技术很难组件大规模的CPU系统。</p><p>NUMA<br><img src="/assets/concurrent-numa-DOPfwcf4.png" alt="NUMA" loading="lazy"></p><p>SMP在扩展能力上有一定限制，针对这一问题的探索成果之一就是NUMA（non-uniform memory access，非一致性内存访问）。<br> 在NUMA架构中，一台服务器有多个节点，每个节点有多个CPU，每个节点有自己的内存，节点可以访问自己的内存（近端内存）和其余节点的内存（远端内存）。CPU和近端内存之间通过片内总线连接，节点之间通过互联模块通信。在NUMA架构中，远端内存的访问速度通常为近端内存的20%-77%</p><p>还有诸多其余的CPU架构，不再列举。<br> SMP优势是访问内存速度快，但是扩展性不足，NUMA则与之相反，远端内存的访问速度较低，但是扩展性优秀。<br> 目前，应用服务器大都基于SMP架构设计的，而大规模的数据存储服务器则是基于NUMA架构设计的。在这里我们主要基于SMP架构</p><h3 id="_2-2-mesi协议" tabindex="-1"><a class="header-anchor" href="#_2-2-mesi协议"><span>2.2 MESI协议</span></a></h3><p>目前来讲，大多数CPU都配备不同层级的缓存(L1-L4等)，越高级的缓存性能越强，且更趋向于CPU独享，不难理解缓存一致性问题出现的原因。为解决这一问题，有了各种缓存一致性协议。不同CPU类型支持的缓存一致性协议是不同的，比如有MSI、MESI、MOSI、MESIF等，其中最常用的是MESI协议及其扩展</p><p>缓存一致性协议大致可分为两种策略：<br> ● 写失效：<br> ○ 当一个处理器写入数据时，它会发送一个失效信号到其他处理器，使得其他处理器的缓存中相应的数据副本被标记为无效。<br> ○ 这种方法可以减少总线上的流量，因为只有在数据被写入时才需要通信。<br> ○ 但是，如果有多个处理器频繁读写同一数据，可能会导致较高的失效和缓存一致性维护开销。<br> ● 写更新：<br> ○ 当一个处理器写入数据时，它会发送更新的数据值到所有其他处理器，使得它们的缓存副本也被更新。<br> ○ 这种方法可以减少因数据失效导致的缓存未命中率，特别是在多个处理器共享读取同一数据的情况下。<br> ○ 然而，这可能导致总线上的流量增加，因为每次写操作都需要通知其他所有处理器。</p><p>写失效在一致性协议中更为常见，接下来我们要讨论的MESI就是一种写失效协议</p><p>MESI分别代表了四种数据状态：<br> ● M（Modify）：表示数据只存在于当前缓存，并且已经被修改，与主存内数据不一致<br> ● E（Exclusive）：表示数据只存在于当前缓存，并且没有被修改<br> ● S（Shared）：表示数据存在于多个缓存，数据与主存保持一致<br> ● I（Invalid）：表示数据失效</p><p>四种状态会基于CPU对数据的操作而发生变更，为了维护状态的准确性，所以有了一些必要的监听机制，如<br> ● 如果一个缓存行处于M状态，则它必须监听所有试图获取该缓存行对应的主存地址的操作，并且在操作执行前将缓存数据写回主存<br> ● 如果一个缓存行处于E状态，则它必须监听所有试图获取该缓存行对应的主存地址的操作，一旦有这种操作，需要将当前缓存行的状态设置为S<br> ● 如果一个缓存行处于S状态，则它需要监听其余的“对该缓存行设置Invalid”和“对该缓存行设置Exclusive的操作”，一旦有这种操作，需要将该缓存行状态设置为Invalid<br> ● 等等等等</p><h4 id="_2-2-1-嗅探协议" tabindex="-1"><a class="header-anchor" href="#_2-2-1-嗅探协议"><span>2.2.1 嗅探协议</span></a></h4><blockquote><p>嗅探协议是一种用于维护多处理器系统中缓存一致性的协议。这种协议在基于共享总线的系统中非常有效，因为每个处理器的缓存都可以监听（&quot;嗅探&quot;）总线上的流量来检测其他缓存所做的读写操作。</p></blockquote><p>在使用 Snoopy 协议的系统中，当一个处理器执行读或写操作时，该操作会在总线上广播。其他处理器的缓存控制器会“嗅探”这些操作，并根据它们对共享数据的操作来更新自己的缓存状态。例如，如果一个处理器写入了一个共享变量，其他处理器的缓存中相应的缓存行可能会被标记为无效（invalid），以确保缓存一致性。</p><p>Snoopy 协议通常与缓存一致性协议（如 MESI 协议）结合使用,过程中涉及到的一些消息类型和对应的描述如下：</p><table><thead><tr><th>消息名</th><th>消息类型</th><th>描述</th></tr></thead><tbody><tr><td>Read</td><td>请求</td><td>该消息包含要读取的Cache Line的物理地址，即告知其余处理器，当前处理器准备读取数据</td></tr><tr><td>Read Response</td><td>响应</td><td>该消息包含Read请求中想要读取的数据，该消息可能来自于主存，可能来自于其余处理器，取决于当前缓存行的状态</td></tr><tr><td>Invalidate</td><td>请求</td><td>通知其余处理器将对应缓存行数据设置invalid状态，即失效缓存</td></tr><tr><td>Invalidate Acknowledge</td><td>响应</td><td>当CPU收到invalidate消息时，需要回复该指令，表示自己的缓存行数据已经失效</td></tr><tr><td>Read Invalidate</td><td>请求</td><td>该消息是一个复合操作，告知其余处理机，当前处理机将读取一个数据，并且进行修改操作，希望其余处理器失效对应的缓存行数据。发送该消息的处理器期望收到一个Read Response和多个Invalidate Acknowledge</td></tr><tr><td>Writeback</td><td>请求</td><td>该消息包含需要写回主存的数据及对应的主存</td></tr><tr><td>...</td><td></td><td></td></tr></tbody></table><h4 id="_2-2-2-store-buffer与invalidate-queue" tabindex="-1"><a class="header-anchor" href="#_2-2-2-store-buffer与invalidate-queue"><span>2.2.2 Store Buffer与Invalidate queue</span></a></h4><p>我们注意到，嗅探协议中很多消息都是需要响应的，于是CPU层面就遇到了和应用层面相类似的场景：同步等待响应的过程阻塞了CPU操作，影响了整体的性能。在解决方法上，CPU层面和业务应用层面也是类似的，即同步改异步，于是就有了 <strong>Store Buffer</strong> ，它相当于一个暂存数据，有了它之后，CPU发出对应的指令后，不再同步等待响应，而是先把数据写入StoreBuffer，之后继续执行后面的指令，之后择机将StoreBuffer的数据刷回缓存行。</p><p>但是显然只有StoreBuffer是不行的，按照上面描述的情况，相当于写操作的时候写入了StoreBuffer，但是数据的时候依然是从缓存行读，那么读就有可能读到脏数据，比如下面这个简单的例子</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>//初始a = 0，是一个shared状态</span></span>
<span class="line"><span>a = 1;</span></span>
<span class="line"><span>b = a+1;</span></span>
<span class="line"><span>assert(b == 2)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>正常来讲，代码中的assert一定为true，但是a = 1这个操作会进入StoreBuffer，之后b = a + 1中从缓存行中读到的a是0，这就导致了assert失败。针对这个问题，我们首先想到的会是提高StoreBuffer在读时候的优先级，先读StoreBuffer再读缓存行，CPU也确实采用了这个机制，被称为<strong>Store Forwarding</strong>，可惜的是，即便有了StoreForwarding，多核在运行时依然会有问题，再看下面这个例子</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>int a = 0, b = 0;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>executeToCPU0(){</span></span>
<span class="line"><span>	a = 1;</span></span>
<span class="line"><span>	b = 1;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>executeToCPU1(){</span></span>
<span class="line"><span>	while(b == 1){</span></span>
<span class="line"><span>		assert(a == 1)</span></span>
<span class="line"><span>	}</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>executeToCPU0在CPU0上执行，executeToCPU1在CPU1上执行。正常来讲，b==1后a必然为1，也就是说断言会成功，但是在我们目前描述的这些机制下，断言依然会失败。推演一下步骤：</p><ol><li>CPU0执行a = 1，a不存在于CPU0的缓存中，此时发送一个read invalidate消息，希望得到a的值，并且希望其余CPU对应的a缓存失效</li><li>CPU0执行b = 1，b存在于缓存行中，处于modify或者exclusive状态，于是直接更新缓存行b=1</li><li>CPU1执行while，b不存在于缓存中，于是发送一个read invalidate消息</li><li>CPU0响应CPU1对b的消息，返回b = 1</li><li>CPU1继续执行assert语句，a存在于CPU1的缓存行中且等于0，于是此时断言失败</li><li>CPU1收到CPU0对a的read invalidate消息，此时才返回a=0，并且失效自己的缓存，但是可见性问题已经发生了</li></ol><p>可以发现，上述问题的核心还是可见性问题，a的写操作无法即时同步给其余处理器，导致结果看起来像是执行乱序了，仿佛是按下面的顺序执行的</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>executeToCPU0(){</span></span>
<span class="line"><span>	b = 1;</span></span>
<span class="line"><span>	a = 1;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，我们知道的StoreBuffer在提升性能的同时引入了可见性问题，导致CPU操作的指令重排，这个问题最终CPU层面的解决方案是内存屏障，关于内存屏障我们之后介绍，现在我们先来看下StoreBuffer导致的另一个问题。<br> StoreBuffer本身容量非常小，容易被打满，里面的数据只能是在接到ACK之后才能清除，而接收方处理器因为运行状况等原因，无法对ACK的时间作出保证。针对这个问题，CPU在响应ACK时也增加了一个异步处理，即增加了一个InvalidateQueue，对于invalidate操作，先响应再处理，以确保StoreBuffer中等待ACK的数据不会过多。<br><img src="/assets/invalidateQueue-CK1tDIPB.png" alt="invalidateQueue" loading="lazy"></p><p>和StoreBuffer类似的是，InvalidateQueue的引入在解决性能问题的同时，也引入了可见性问题，会导致指令重排。依然看这个例子：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>int a = 0, b = 0;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>executeToCPU0(){</span></span>
<span class="line"><span>	a = 1;</span></span>
<span class="line"><span>	b = 1;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>executeToCPU1(){</span></span>
<span class="line"><span>	while(b == 1){</span></span>
<span class="line"><span>		assert(a == 1)</span></span>
<span class="line"><span>	}</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>和之前执行步骤不同的是，这次对于a的invalidate操作已经被CPU1处理，但是它放在了InvalidateQueue当中并未及时生效，因此导致了断言失败。<br> 我们发现，上面描述的两种问题都是因为StoreBuffer或InvalidateQueue的数据没有及时生效，而CPU针对这些情况并没有再进行一些强制的保障，而是提供了内存屏障，将具体的控制器交给开发者</p><h3 id="_2-3-内存屏障" tabindex="-1"><a class="header-anchor" href="#_2-3-内存屏障"><span>2.3 内存屏障</span></a></h3><p>大多数处理器都会提供一下几种内存屏障，以X86为例：<br> ● 读屏障（lfence, load fence）：将invalidate queue中的指令立即处理，并且强制读取缓存行。执行ifence指令之后的操作不会被排到执行ifence之前。这意味着其余CPU暴露出来的缓存行状态对当前CPU可见。（一定要读最新值）<br> ● 写屏障（sfence, store fence）：将Store buffer中的数据修改刷新到本地缓存中，使得其它CPU能看到这些修改。执行sfence之后操作不会被排到执行sfence之前，这意味着执行sfence之前的操作一定全局可见。（写的最新值一定要让所有人都知道）<br> ● 读写屏障（mfence, memeory fence）：相当于ifence和sfence的混合，保证顺序及可见<br> 此外，Lock指令用来修饰操作符，保证原子性，它具有mfence的效果。也就是说任何一个指令搭配上Lock前缀都有内存屏障的效果。在常见的X86架构下，常常使用Lock加一个空操作来实现内存屏障。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>读写屏障的功能可以这么记忆：</p><ul><li>读屏障：我想要的是读到最新的数据，我自己写的我肯定能读到，而我这里和别人的写操作相关的就是invalidateQueue，所有需要刷一把它</li><li>写屏障：我想要的是我写完之后大家都能读到最新的，但我管不了其他人，我只能保证我写完之后你再来问我，我一定给到你最新的。我最新的写操作可能在storeBuffer里面，但是你没法读，所有我刷回内存给你读</li></ul></div><p>不同的操作系统会封装不同的方法来对CPU的内存屏障指令进行调用，比如Linux中基于汇编宏命令构建了三种基础的内存屏障：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>// :::&quot;memory&quot; 是 GCC 内联汇编的一种语法，用于告诉编译器这段汇编代码可能会影响内存，</span></span>
<span class="line"><span>// 因此编译器应该假设所有缓存的内存值都是无效的，并在需要时重新加载它们。</span></span>
<span class="line"><span>// 编译器决定具体该怎么做，可能会使用lfence、mfence、sfence</span></span>
<span class="line"><span>#define lfence() __asm__ __volatile__(&quot;mfence&quot; ::: &quot;memory&quot;);</span></span>
<span class="line"><span>#define sfence() __asm__ __volatile__(&quot;sfence&quot; ::: &quot;memory&quot;);</span></span>
<span class="line"><span>#define mfence() __asm__ __volatile__(&quot;mfence&quot; ::: &quot;memory&quot;);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">上次编辑于: </span><span class="vp-meta-info" data-allow-mismatch="text">2024/12/22 07:41:10</span></div><div class="contributors"><span class="vp-meta-label">贡献者: </span><!--[--><!--[--><span class="vp-meta-info" title="email: suncheng11@meituan.com">suncheng11</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><!----><a class="route-link auto-link next" href="/posts/rd/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/java-concurrent-3.html" aria-label="Java多线程总结（三）：volatile与Synchronized"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">Java多线程总结（三）：volatile与Synchronized<span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">花有重开日，人无再少年</div><div class="vp-copyright">Copyright © 2025 Raymond </div></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-pa7HclEc.js" defer></script>
  </body>
</html>
